name: Build APK after Python generation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Забираем репозиторий
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2. Устанавливаем Python
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Устанавливаем зависимости Python (если есть requirements.txt)
    - name: Install Python dependencies
      run: |
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    # 4. Запускаем Python-скрипт генерации Android-проекта
    - name: Run project generator
      run: |
        python3 setup_project.py
      continue-on-error: false

    # 5. Делаем gradlew исполняемым
    - name: Make gradlew executable
      run: |
        chmod +x ./gradlew || true
        chmod +x */gradlew || true

    # 6. Устанавливаем JDK
    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: 17

    # 7. Собираем Debug APK
    - name: Build Debug APK
      run: |
        ./gradlew assembleDebug --stacktrace

    # 8. Загружаем apk как артефакт
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kakdela-debug-apk
        path: app/build/outputs/**/*.apk
