name: Scan and Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  scan_and_build:
    runs-on: ubuntu-latest

    steps:

      # -------------------------------
      # 1. CHECKOUT
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # 2. CREATE FULL SCAN REPORT
      # -------------------------------
      - name: Scan repository tree
        run: |
          mkdir scan_output
          echo "===== FILE TREE =====" > scan_output/scan_report.txt
          tree -a . >> scan_output/scan_report.txt

          echo "" >> scan_output/scan_report.txt
          echo "===== FILE CONTENT =====" >> scan_output/scan_report.txt

          # Безопасное сканирование файлов
          find . -type f ! -name "scan_report.txt" -print0 | while IFS= read -r -d '' file
          do
            echo "" >> scan_output/scan_report.txt
            echo "----- $file -----" >> scan_output/scan_report.txt
            sed 's/\x0//g' "$file" >> scan_output/scan_report.txt 2>/dev/null || echo "[binary file]" >> scan_output/scan_report.txt
          done

      # -------------------------------
      # 3. ZIP REPORT
      # -------------------------------
      - name: Zip scan report
        run: |
          cd scan_output
          zip ../scan_report.zip scan_report.txt
          cd ..

      - name: Upload scan report
        uses: actions/upload-artifact@v4
        with:
          name: repository-full-scan
          path: scan_report.zip

      # -------------------------------
      # 4. SETUP JAVA
      # -------------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # -------------------------------
      # 5. MAKE GRADLEW EXECUTABLE
      # -------------------------------
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # -------------------------------
      # 6. BUILD APK
      # -------------------------------
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      # -------------------------------
      # 7. UPLOAD APK ARTIFACT
      # -------------------------------
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Kakdela-debug-apk
          path: app/build/outputs/apk/debug/*.apk
